# 急速监控工具 PRD

## 1. 背景与目标
- **业务背景**：传统AI获取前后端日志报错过于困难，Ctrl+C的复制繁琐且不科学。急速监控工具旨在提供统一、轻量的本地日志读取与管理能力，支撑前后端及其他业务线快速排障。
- **目标指标**：
  - 90% 的日志检索需求可在 30 秒内完成输出（含过滤与压缩操作）。
  - 单次查询的 token 消耗不超过传统聊天截屏方案的 20%，即<1,000 token/会话。
  - 至少覆盖当前全部活跃服务（前端、后端、批处理任务）的日志模板并形成落地规范。
- **成功判定**：两周内由 3 名开发独立使用工具完成问题定位且无重大阻塞反馈；日志清理与打包流程在周会巡检中通过验证。

## 2. 用户画像与使用场景
- **核心用户**：前端、后端、测试、运维工程师以及临时排障Agent。
- **典型场景**：  
  1. 开发者定位当天线上异常，使用 `check_log.cmd` 默认参数快速查看对应服务今日日志。  
  2. QA 验证缺陷复现窗口，传入服务 + 日期 + 行区间提取关键片段并与研发同步。  
  3. 运维在例行巡检时调用 `manage_log.sh --clear -before d7 -service api-gateway` 清理指定服务过期日志，并用 `--zip` 汇总当周异常以归档。
- **使用频次**：高（每日多次）。

## 3. 范围与边界
- **In Scope**：
  - 日志目录由各服务自行规划与挂载，工具默认按 `logs/<service>/` 约定查找，但不强制迁移或改名，只要服务将日志写入可解析路径即可被读取。
  - 查询脚本 `check_log.cmd/.sh` 支持的过滤参数：服务（必填/默认最近使用）、日期（默认今日）、首行数、末行数。
  - 日志管理脚本 `manage_log.cmd/.sh` 的清理、压缩、占用检查能力：`--clear -before <dx>`、`--clear -using`、`--clear -mlm <size>`、`--zip <name> ...`。
  - 输出展示采用命令行/终端输出与本地压缩包，无需依赖远端服务。
- **Out of Scope**：
  - 实时流式日志推送、图形化界面及报警系统。
  - 自动化日志采集（例如从容器或远程服务器抓取），当前聚焦于本地/CI 产出的文件。
  - 权限控制与多租户隔离（默认单仓库内受控团队共享）。

### 命令与参数设计

#### `check_log` 必备参数
| 参数 | 命令形式（长/短） | 类型与格式 | 默认值 | 说明与校验 |
| --- | --- | --- | --- | --- |
| 服务 | `--service`, `-s` | 字符串；允许字母、数字、短横线 | 最近一次成功查询的服务；若无缓存则交互提示 | 必填参数；优先查找 `logs/<service>/`，不存在时提示当前仓库已挂载的服务目录列表。 |
| 日期 | `--date`, `-d` | `YYYY-MM-DD` 或相对日期：`today`、`yesterday`、`d-<n>` | `today` | 组合为 `<date>.log` 文件名；找不到时返回该服务最近 7 天内实际存在的日志日期。 |
| 行窗口 | `--tail`, `-t` | 正整数 (10–500) | 200 | 展示文件尾部若干行，控制台默认输出 = 200 行；超出范围提示有效区间。 |
| 起始行 | `--start` | 正整数 | 自动回退至 `max(total_lines-200, 1)` | 与 `--end` 搭配使用；若未传 `--end` 则展示从 `start` 起 200 行。 |
| 结束行 | `--end` | 正整数 | 文件总行数 | 与 `--start` 协同，若 `end < start` 自动调整顺序并给出提示。 |
| 关键词（必备） | `--keyword`, `-k` | 字符串，可多次传入 | 至少需提供一次或通过配置预设 | 用于过滤带有特定模块/组件前缀的行，例如 `[inventory]`；多次传入时采用 AND 逻辑。 |

> 关键词过滤为核心能力：若用户未显式提供 `--keyword`，脚本会提示输入或读取 `RAPID_MONITOR_DEFAULT_KEYWORD` 环境变量；仍为空则拒绝执行。

可选附加参数（保持轻量）：
- `--plain`：关闭彩色高亮，便于复制粘贴。
- `--output <path>`：将过滤结果写入文件；若文件存在需搭配 `--force`。
- `RAPID_MONITOR_DEFAULT_SERVICE` 环境变量：提供默认服务名，优先级低于显式参数。

执行顺序：确定服务与日期 → 读取行窗口 → 执行关键词过滤 → 输出结果（终端或文件）。

#### `manage_log` 清理参数
| 参数 | 命令形式 | 类型与格式 | 默认值 | 说明与校验 |
| --- | --- | --- | --- | --- |
| 清理入口 | `--clear` | flag | 必须显式指定 | 进入清理模式。 |
| 服务过滤 | `-service <name>` | 字符串，可多次 | 全部服务 | 指定一个或多个服务目录进行清理。 |
| 时间阈值 | `-before <dN\|YYYY-MM-DD>` | 相对天数或绝对日期 | 无 | 删除早于阈值的日志，默认保留当天文件。 |
| 大文件阈值 | `-mlm <size>` | 数值 + 单位（如 `30KB`） | 无 | 只清理超过指定体积的日志，防止误删小文件。 |
| 干跑模式 | `--dry-run` | flag | `false` | 仅输出拟删除文件及体积，便于确认。 |
| 保留最新 | `--keep-latest <n>` | 正整数 | 1 | 每个服务至少保留 n 个最近日志后再执行删除。 |

#### `manage_log` 打包参数
| 参数 | 命令形式 | 类型与格式 | 默认值 | 说明与校验 |
| --- | --- | --- | --- | --- |
| 打包入口 | `--zip <archive>` | 必填：归档名或路径 | 无 | 若无扩展名自动补 `.zip`，生成到 `logs/archive/`。 |
| 服务筛选 | `-service <name>` | 字符串，可多次 | 全部服务 | 选择要归档的服务日志。 |
| 日期范围 | `-from <YYYY-MM-DD>` / `-to <YYYY-MM-DD>` | 日期 | `from`: 七天前；`to`: 今日 | 控制归档时间窗口；错误顺序时自动纠正并提示。 |
| 干跑模式 | `--dry-run` | flag | `false` | 仅列出将被打包的文件清单。 |
| 追加模式 | `--append` | flag | `false` | 若压缩包已存在，允许追加写入；默认重新创建。 |

补充规则：
- 工具不改变现有日志目录的命名方式，只要服务能将日志输出到 `logs/` 下的可识别目录即可。
- `check_log` 默认执行 `--tail 200`；若同时提供 `--start/--end`，以显式范围优先。
- 关键词过滤不可跳过，保障输出集中在目标模块或业务前缀。
- `manage_log` 支持在同一命令中先 `--zip` 再 `--clear`（若两者同时出现），除非指定 `--dry-run`。

## 4. 数据与集成
- **输入数据**：纯文本日志文件，UTF-8 编码；由各业务服务在构建/运行阶段写入 `logs/` 目录，更新频率按服务产生日志时即时追加，责任人为对应服务的技术 owner。
- **输出结果**：
  - 标准输出：符合过滤条件的日志片段（默认展示末尾 200 行或指定区间）。
  - 可选压缩：通过 `manage_log --zip <bundle>` 将筛选结果或待归档日志写入指定压缩包（zip）。
  - 清理结果：命令行返回清理文件数量及释放空间统计。
- **系统依赖**：跨平台脚本依赖原生 shell（Windows CMD/Powershell、类 Unix Bash）；文件系统需允许读写仓库 `logs/` 目录；压缩功能依赖系统原生 zip 命令或 Python/7zip（根据实现方案确定）。

## 5. 里程碑
| 阶段 | 时间 | 交付物 |
| --- | --- | --- |
| 规划 | 2025-11-02 | 完成需求评审、确认日志目录与参数规范 |
| 开发 | 2025-11-05 | 实现 `check_log` 与 `manage_log` 脚本 MVP，覆盖 Windows / Unix 平台示例 |
| 验证 | 2025-11-08 | 通过试点团队联调，输出使用手册与常见问题清单 |
| 发布 | 2025-11-10 | 在主分支落地并纳入周例行运维流程 |

## 6. 风险与假设
- **关键假设**：
  - 各服务会在仓库中维护可访问的日志目录，并在目录结构调整时同步更新配置清单。
  - 团队成员具备本地脚本执行权限，且仓库具备充足存储空间用于短期日志归档。
- **风险清单**：
  - 风险：日志文件体积快速膨胀导致查询耗时；缓解：引入 `首行数/末行数` 控制与默认 tail 限制，并在 `manage_log` 中设置更灵活的 `-mlm`（最大文件大小）策略。
  - 风险：跨平台兼容问题（Windows 与类 Unix 行为差异）；缓解：在 CI 中增加双平台脚本冒烟测试，并在 FUNCTION 文档中列出差异。
  - 风险：压缩归档遗漏依赖或命名不统一；缓解：在 `--zip` 执行后输出目标路径及命名示例，并引入固定存储目录（如 `logs/archive/`）。

## 7. Open Questions
- 日志服务目录命名是否需要与服务注册中心或仓库子包保持一一对应？
- 是否需要为查询结果提供额外的高亮或关键字过滤能力？
- 压缩归档的默认存放路径、生命周期与备份策略是否需要纳入本工具？
